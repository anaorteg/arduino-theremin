<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Arduino Theremin: /Users/brianmclaughlin/Documents/arduino/arduino-theremin/arduino-source/theremin/theremin.ino Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Arduino Theremin
   
   </div>
   <div id="projectbrief">Creation of a Theremin utilizing the Arduino environment.</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/Users/brianmclaughlin/Documents/arduino/arduino-theremin/arduino-source/theremin/theremin.ino</div>  </div>
</div><!--header-->
<div class="contents">
<a href="theremin_8ino.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;avr/wdt.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;avr/interrupt.h&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;avr/pgmspace.h&gt;</span>
<a name="l00057"></a>00057 
<a name="l00071"></a><a class="code" href="group__globals-waveform.html#ga1d58135a8b47accb48a9572252272460">00071</a> PROGMEM  prog_uchar <a class="code" href="group__globals-waveform.html#ga1d58135a8b47accb48a9572252272460" title="Table of 256 sine values, one sine period, stored in flash memory.">sine256</a>[]  = {
<a name="l00072"></a>00072   127,130,133,136,139,143,146,149,152,155,158,161,164,167,170,173,176,178,181,184,187,190,192,195,198,200,203,205,208,210,212,215,217,219,221,223,225,227,229,231,233,234,236,238,239,240,
<a name="l00073"></a>00073   242,243,244,245,247,248,249,249,250,251,252,252,253,253,253,254,254,254,254,254,254,254,253,253,253,252,252,251,250,249,249,248,247,245,244,243,242,240,239,238,236,234,233,231,229,227,225,223,
<a name="l00074"></a>00074   221,219,217,215,212,210,208,205,203,200,198,195,192,190,187,184,181,178,176,173,170,167,164,161,158,155,152,149,146,143,139,136,133,130,127,124,121,118,115,111,108,105,102,99,96,93,90,87,84,81,78,
<a name="l00075"></a>00075   76,73,70,67,64,62,59,56,54,51,49,46,44,42,39,37,35,33,31,29,27,25,23,21,20,18,16,15,14,12,11,10,9,7,6,5,5,4,3,2,2,1,1,1,0,0,0,0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,9,10,11,12,14,15,16,18,20,21,23,25,27,29,31,
<a name="l00076"></a>00076   33,35,37,39,42,44,46,49,51,54,56,59,62,64,67,70,73,76,78,81,84,87,90,93,96,99,102,105,108,111,115,118,121,124
<a name="l00077"></a>00077 };
<a name="l00084"></a><a class="code" href="group__globals-pins.html#ga7febbeaa817de864b39bfb686b8d8200">00084</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="group__globals-pins.html#ga7febbeaa817de864b39bfb686b8d8200" title="RF Frequency input from oscillator (RESERVED FOR TIMER 1 INPUT)">PIN_RF_FREQ</a>    = 5; 
<a name="l00085"></a><a class="code" href="group__globals-pins.html#ga862e7a628eb66f12daf7aba92081bb75">00085</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="group__globals-pins.html#ga862e7a628eb66f12daf7aba92081bb75" title="PWM Based Audio Output from Arduino.">PIN_AUDIO_OUT</a> = 11; 
<a name="l00092"></a><a class="code" href="group__globals-constants.html#ga4fd783695c25b9ced260c4ae38782e4f">00092</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <a class="code" href="group__globals-constants.html#ga4fd783695c25b9ced260c4ae38782e4f" title="Timer/Counter 1 is a 16-bit counter so it rolls over at 0xFFFF.">TIMER1_ROLLOVER_VALUE</a> = 0xFFFF;  
<a name="l00093"></a><a class="code" href="group__globals-constants.html#gafaf07345193d633dc676404a52e2dd56">00093</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="group__globals-constants.html#gafaf07345193d633dc676404a52e2dd56" title=" (size of an unsigned integer or 16 bits)">DDS_COEFFICIENT</a>       = 65536;   
<a name="l00094"></a><a class="code" href="group__globals-constants.html#ga532a3aa7abae74d163c979828dafb6ef">00094</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="group__globals-constants.html#ga532a3aa7abae74d163c979828dafb6ef" title="The frequency of the watch-dog timer clock overflow.">DDS_REFERENCE_CLOCK</a>   = 31377;   
<a name="l00095"></a><a class="code" href="group__globals-constants.html#ga301908d1c1d203d9bd9623a310e00c7b">00095</a> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="group__globals-constants.html#ga301908d1c1d203d9bd9623a310e00c7b" title="The hardware resonator is tuned to 4.11 MHz.">OSCILLATOR_FREQUENCY</a>  = 4112254; 
<a name="l00102"></a><a class="code" href="group__globals-volatiles.html#gaaa89f188c977b289de49c3230bb21298">00102</a> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="group__globals-volatiles.html#gaaa89f188c977b289de49c3230bb21298" title="Frequency input overflow.">frequency_input_overflow</a> = 0;  
<a name="l00103"></a><a class="code" href="group__globals-volatiles.html#ga15ab42c386b8f4fc9766a4af70b1d03d">00103</a> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <a class="code" href="group__globals-volatiles.html#ga15ab42c386b8f4fc9766a4af70b1d03d" title="DDS phase accumulator.">dds_phase_accumulator</a>    = 0;  
<a name="l00104"></a><a class="code" href="group__globals-volatiles.html#ga411b26fb51750078b83ed9b5d17c89ff">00104</a> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>  <a class="code" href="group__globals-volatiles.html#ga411b26fb51750078b83ed9b5d17c89ff" title="DDS tuning word M.">dds_jump_size</a>            = 0;  
<a name="l00114"></a><a class="code" href="group__globals.html#ga4fc01d736fe50cf5b977f755b675f11d">00114</a> <span class="keywordtype">void</span> <a class="code" href="group__globals.html#ga4fc01d736fe50cf5b977f755b675f11d" title="The standard Arduino setup function.">setup</a>() {
<a name="l00115"></a>00115 
<a name="l00116"></a>00116   <span class="comment">// Configure the Arduino IO Pins</span>
<a name="l00117"></a>00117   pinMode(<a class="code" href="group__globals-pins.html#ga7febbeaa817de864b39bfb686b8d8200" title="RF Frequency input from oscillator (RESERVED FOR TIMER 1 INPUT)">PIN_RF_FREQ</a>,   INPUT);  <span class="comment">// Set the RF pin for input</span>
<a name="l00118"></a>00118   pinMode(<a class="code" href="group__globals-pins.html#ga862e7a628eb66f12daf7aba92081bb75" title="PWM Based Audio Output from Arduino.">PIN_AUDIO_OUT</a>, OUTPUT); <span class="comment">// Set the audio out pin for output</span>
<a name="l00119"></a>00119   
<a name="l00120"></a>00120   <span class="comment">// Configure the timers</span>
<a name="l00121"></a>00121   cli();            <span class="comment">// Disable interrups before we configure the timer interrupts</span>
<a name="l00122"></a>00122   <a class="code" href="group__globals.html#gadc3f86fb035dd66911f621a199f3d6b0" title="Set-up the Watchdog timer registers.">watchdog_setup</a>(); <span class="comment">// Configure the watchdog timer</span>
<a name="l00123"></a>00123   <a class="code" href="group__globals.html#ga09dd35e11fe4a5c9278847c009477602" title="Set-up Timer/Counter 1 registers.">timer1_setup</a>();   <span class="comment">// Configure timer/counter 1</span>
<a name="l00124"></a>00124   <a class="code" href="group__globals.html#ga14bcc531b1ef936801d01efc65917812" title="Set-up Timer/Counter 2 registers.">timer2_setup</a>();   <span class="comment">// configure timer/counter 2</span>
<a name="l00125"></a>00125   sei();            <span class="comment">// Enable interrupts</span>
<a name="l00126"></a>00126 }
<a name="l00127"></a>00127 
<a name="l00135"></a><a class="code" href="group__globals.html#gafe461d27b9c48d5921c00d521181f12f">00135</a> <span class="keywordtype">void</span> <a class="code" href="group__globals.html#gafe461d27b9c48d5921c00d521181f12f" title="The standard Arduino loop function.">loop</a>() {}
<a name="l00136"></a>00136 
<a name="l00144"></a><a class="code" href="group__globals.html#gadc3f86fb035dd66911f621a199f3d6b0">00144</a> <span class="keywordtype">void</span> <a class="code" href="group__globals.html#gadc3f86fb035dd66911f621a199f3d6b0" title="Set-up the Watchdog timer registers.">watchdog_setup</a>(){
<a name="l00145"></a>00145   wdt_reset();                 <span class="comment">// Stroke the WDT before configuration.</span>
<a name="l00146"></a>00146   WDTCSR = (1&lt;&lt;WDCE)|(1&lt;&lt;WDE); <span class="comment">// Setup WDT interrupt.</span>
<a name="l00147"></a>00147   WDTCSR = (1&lt;&lt;WDIE);          <span class="comment">// Enable WDT interrupt with 16ms interrupt cycle</span>
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00159"></a><a class="code" href="group__globals.html#ga09dd35e11fe4a5c9278847c009477602">00159</a> <span class="keywordtype">void</span> <a class="code" href="group__globals.html#ga09dd35e11fe4a5c9278847c009477602" title="Set-up Timer/Counter 1 registers.">timer1_setup</a>(){
<a name="l00160"></a>00160     
<a name="l00161"></a>00161   <span class="comment">// set timer/counter1 hardware as counter on rising edges, counts events on pin T1 (Arduino pin 5)</span>
<a name="l00162"></a>00162   TCCR1B  = (1&lt;&lt;CS12) | (1&lt;&lt;CS11) | (1&lt;&lt;CS10);
<a name="l00163"></a>00163   TIMSK1 |= (1&lt;&lt;TOIE1); <span class="comment">// allow timer/counter 1 to trigger an interrupt on overflow</span>
<a name="l00164"></a>00164   TIFR1  |= (1&lt;&lt;TOV1);  <span class="comment">// Ensure that the overflow timer is clear</span>
<a name="l00165"></a>00165   TCNT1   = 0;          <span class="comment">// reset timer/counter 1 value</span>
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00174"></a><a class="code" href="group__globals.html#ga14bcc531b1ef936801d01efc65917812">00174</a> <span class="keywordtype">void</span> <a class="code" href="group__globals.html#ga14bcc531b1ef936801d01efc65917812" title="Set-up Timer/Counter 2 registers.">timer2_setup</a>(){
<a name="l00175"></a>00175   <span class="comment">// Configure the timer/counter 2 configuration registers, TCCR2A and TCCR2B</span>
<a name="l00176"></a>00176   TCCR2A = (1&lt;&lt;COM2A1)|(1&lt;&lt;WGM20);
<a name="l00177"></a>00177   TCCR2B = (1&lt;&lt;CS20);
<a name="l00178"></a>00178   
<a name="l00179"></a>00179   <span class="comment">// Configure Timer/Counter 2 Interrupt Mask Register to enable</span>
<a name="l00180"></a>00180   <span class="comment">// the overflow interrupts.</span>
<a name="l00181"></a>00181   TIMSK2 |= (1&lt;&lt;TOIE2);
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00185"></a><a class="code" href="group__globals.html#ga43905d6fb5c4d433a49f527fa6ab811f">00185</a> <a class="code" href="group__globals.html#ga43905d6fb5c4d433a49f527fa6ab811f" title="Watchdog Timer Interrupt Service Routine.">ISR</a>(WDT_vect) {
<a name="l00186"></a>00186   
<a name="l00187"></a>00187   <span class="comment">// calculate new frequency value</span>
<a name="l00188"></a>00188   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> frequency_input = <a class="code" href="group__globals-volatiles.html#gaaa89f188c977b289de49c3230bb21298" title="Frequency input overflow.">frequency_input_overflow</a> * <a class="code" href="group__globals-constants.html#ga4fd783695c25b9ced260c4ae38782e4f" title="Timer/Counter 1 is a 16-bit counter so it rolls over at 0xFFFF.">TIMER1_ROLLOVER_VALUE</a>;
<a name="l00189"></a>00189   frequency_input += TCNT1;         <span class="comment">// add Timer/Counter 1 register value</span>
<a name="l00190"></a>00190   frequency_input *= 61;            <span class="comment">// convert to cycles/second</span>
<a name="l00191"></a>00191   
<a name="l00192"></a>00192   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> frequency_delta = <a class="code" href="group__globals-constants.html#ga301908d1c1d203d9bd9623a310e00c7b" title="The hardware resonator is tuned to 4.11 MHz.">OSCILLATOR_FREQUENCY</a> - frequency_input;
<a name="l00193"></a>00193   frequency_delta = abs(frequency_delta);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> new_output_frequency = abs(frequency_delta);
<a name="l00196"></a>00196   
<a name="l00197"></a>00197   <a class="code" href="group__globals-volatiles.html#ga411b26fb51750078b83ed9b5d17c89ff" title="DDS tuning word M.">dds_jump_size</a> = (<a class="code" href="group__globals-constants.html#gafaf07345193d633dc676404a52e2dd56" title=" (size of an unsigned integer or 16 bits)">DDS_COEFFICIENT</a> * new_output_frequency) / <a class="code" href="group__globals-constants.html#ga532a3aa7abae74d163c979828dafb6ef" title="The frequency of the watch-dog timer clock overflow.">DDS_REFERENCE_CLOCK</a>;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199   TCNT1 = 0;                       <span class="comment">// reset timer/counter 1</span>
<a name="l00200"></a>00200   <a class="code" href="group__globals-volatiles.html#gaaa89f188c977b289de49c3230bb21298" title="Frequency input overflow.">frequency_input_overflow</a> = 0;    <span class="comment">// reset timer/counter 1 overflow counter</span>
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00204"></a><a class="code" href="group__globals.html#gab16889ae984b9b798989a0d239283cac">00204</a> <a class="code" href="group__globals.html#ga43905d6fb5c4d433a49f527fa6ab811f" title="Watchdog Timer Interrupt Service Routine.">ISR</a>(TIMER1_OVF_vect) {
<a name="l00205"></a>00205   <a class="code" href="group__globals-volatiles.html#gaaa89f188c977b289de49c3230bb21298" title="Frequency input overflow.">frequency_input_overflow</a>++; <span class="comment">// Increment the Timer/Counter 1 overflow count</span>
<a name="l00206"></a>00206   TIFR1 |= (1&lt;&lt;TOV1);         <span class="comment">// Clear the overflow flag</span>
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00210"></a><a class="code" href="group__globals.html#ga7cfcbe42bd266750aeb6e5d71e5ea479">00210</a> <a class="code" href="group__globals.html#ga43905d6fb5c4d433a49f527fa6ab811f" title="Watchdog Timer Interrupt Service Routine.">ISR</a>(TIMER2_OVF_vect) {
<a name="l00211"></a>00211 
<a name="l00212"></a>00212   <span class="comment">// DDS Phase Accmulator Incremented by the DDS Jump Size</span>
<a name="l00213"></a>00213   <a class="code" href="group__globals-volatiles.html#ga15ab42c386b8f4fc9766a4af70b1d03d" title="DDS phase accumulator.">dds_phase_accumulator</a> += <a class="code" href="group__globals-volatiles.html#ga411b26fb51750078b83ed9b5d17c89ff" title="DDS tuning word M.">dds_jump_size</a>; 
<a name="l00214"></a>00214   
<a name="l00215"></a>00215   <span class="comment">// use upper 8 bits for phase accu as frequency information</span>
<a name="l00216"></a>00216   <span class="comment">// read value fron ROM sine table and send to PWM DAC</span>
<a name="l00217"></a>00217   OCR2A=pgm_read_byte_near(<a class="code" href="group__globals-waveform.html#ga1d58135a8b47accb48a9572252272460" title="Table of 256 sine values, one sine period, stored in flash memory.">sine256</a> + (<a class="code" href="group__globals-volatiles.html#ga15ab42c386b8f4fc9766a4af70b1d03d" title="DDS phase accumulator.">dds_phase_accumulator</a> &gt;&gt; 8));  
<a name="l00218"></a>00218 }
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Mon Apr 16 2012 20:17:29 for Arduino Theremin by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.0
</small></address>

</body>
</html>
